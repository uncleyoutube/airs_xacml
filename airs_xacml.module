<?php
/**
 * Implements hook_islandora_object_ingested
 */
function airs_xacml_islandora_object_ingested($object) {
  $mods = new SimpleXMLElement($object['MODS']->getContent(''));
  airs_xacml_apply_policy($mods, $object);
}

/**
 * Implements hook_islandora_datastream_modified
 */
function airs_xacml_islandora_datastream_modified($object, $datastream) {
  if ($datastream->label === 'MODS Record') { 
    dpm('copying mods');
    $mods = new SimpleXMLElement($object['MODS']->getContent(''));
    dpm('copied mods');
    if (isset($object['POLICY'])) 
      $object->purgeDatastream('POLICY'); // this is what breaks everything
    airs_xacml_apply_policy($mods, $object);
  }
}

function airs_xacml_apply_policy($mods, $object) {
  // DECLARATIONS
  global $user;

  dpm('declaring $userAccess');

  // decalaring $userAccess
  foreach ($mods->accessCondition as $access) {
    switch((string) $access['type']) {
    case 'restriction on access':
      $userAccess = (string)$access;
      break;
    }
  }

  dpm('declaring $contributors');

  // declaring $contributors
  $n=0;
  foreach ($mods->name as $name) {
    switch((string) $name['type']) {
    case 'personal':
      foreach($name->namePart as $namePart) {
        $contributors[$n] = (string)$namePart;
        $n++;
      }
      break;
    }
  }

  dpm('declaring $themes');

  // declaring $themes
  $t=0;
  foreach ($mods->genre as $genre) {
    switch((string) $genre['type']) {
    case 'themes':
      $themes[$t] = (string)$genre;
      $t++;
      break;
    }
  }

  dpm('creating new xacml obj');

  // create new IslandoraXacml object, link it to the object being ingested
  $xacml = new IslandoraXacml($object);

  dpm('created new xacml obj');

  // allow the user to view and manage the file
  // the administrative role gets this by default
  $xacml->viewingRule->addUser(array($object->owner));
  $xacml->managementRule->addUser(array($object->owner)); 

  dpm('added owner to rules');

  if ($userAccess != 'User only') {
    dpm('is not user only');
    // grabs all users listed as collaborators
    foreach ($contributors as $name) {
      $xacml->viewingRule->addUser(array($name));
      $xacml->managementRule->addUser(array($name));
    }

    dpm('switch block');
    // use the userAccess field of the form to determine extra permissions
    switch($userAccess) {
      case 'Public':
        dpm('public');
        $xacml->viewingRule->addRole(array('anonymous user', 'authenticated user'));
        if (airs_xacml_is_collection($object)) {
          $xacml->managementRule->addRole(array('Member'));
        }
        break;

      case 'Registered users':
        dpm('registered');
        $xacml->viewingRule->addRole(array('authenticated user'));
        if (airs_xacml_is_collection($object)) {
          $xacml->managementRule->addRole(array('Member'));
        }
        break;

      case 'My sub-theme':
        dpm('my sub-theme');
        // returns all themes listed in the AIRS Themes field
        foreach ($themes as $theme) {
          // checks if the listing is a string, then if begins with Subtheme
          if (is_string($theme) && strlen($theme) > 5) {
            if (substr($theme, 0, 8) == 'Subtheme') { 
              $subthemeID = 'st'.substr($theme, 9, 3); 
              $xacml->viewingRule->addRole(array($subthemeID));
              $xacml->managementRule->addRole(array($subthemeID));
            }
          } 
        }
      break;
    }
  } else { dpm('is user only'); }
  // save the policy
  dpm('before policy save');
  $xacml->writeBackToFedora();
  dpm('after policy save');
}

function airs_xacml_is_collection($object) {
  if (strcmp($object->models[0], 'islandora:collectionCModel') == 0) {
    return true;
  } else {
    return false;
  }
}
